<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Autodesk Helpful</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
        <!-- build:css(.tmp) styles/main.css -->
        <link rel="stylesheet" href="styles/main.css">
        <!-- endbuild -->
        <!-- build:js scripts/vendor/modernizr.js -->
        <script src="bower_components/modernizr/modernizr.js"></script>
        <!-- endbuild -->
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
        <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.4/themes/smoothness/jquery-ui.css" />
        <style>
            @font-face {
                font-family: "open-sans";
                src: url("//mozorg.cdn.mozilla.net/media/fonts/OpenSans-Light-webfont.woff") format('woff');
            }
            .helpful{
                padding: 20px 0 20px 0;
                border-top: 1px solid #cccccc;
                border-bottom: 1px solid #cccccc;
                color: #757575;
            }

            .helpful > button{
                margin-left: 10px;
            }

            .helpful-container{
                font-family: "open-sans", "Times New Roman", sans-serif;
                font-size: 1em;
                color: #777777;
                cursor : pointer;
            }
            .helpful-logo{
                font-size: 1em;
            }
            .helpful-counter{
                font-size: 0.7em;
            }

            /*user defined classes*/
            .rounded{
                -moz-border-radius: 5px;
                -webkit-border-radius: 5px;
                border-radius: 5px;
                padding: 5px;
            }
            .border{
                border: 1px solid #dedede;
            }
            .border:active {
                margin: 2px 0 0 2px;
                border: 1px solid #777777;
            }
            p{
                border-bottom: 1px solid #dedede;
            }
            .left{
                float: left;
            }
            .right{
                float: right;
            }

            .cat-left{
                float: left;
                height: 230px;
            }
            .list-right{
                float: right;
                clear: none;
            }
            .code-blocks{
                margin: 10px 0;
            }
            .both{
                clear: both;
            }
            .other-elements{
                margin-top: 10px;
                padding: 10px;
                background: rgba(255, 120, 201, 0.30);
                text-align: center;
            }

            @media screen and (max-width: 480px){

                .cat-left{
                    float:left;
                    display:block;
                    width:100%;
                }

                .list-right{
                    float:none;
                    display:block;
                    width:100%;
                    clear: both;
                }
            }
        </style>
    </head>
    <body>

        <div class="container">
            <div class="helpful rounded"></div>
        </div>

        <script>

            ;(function($, window, document, undefined){

                console.log('jquery: ', $.fn.jquery);
                console.log('jquery-ui', $.ui.version);

                $.widget('autodesk.helpful', {

                    options: {

                        url: '//hype-rulz.herokuapp.com',
                        helpfulId : 'helpfulId',
                        helpfulCookie: 'autodeskHelpfulCookie',
                        baseClass : 'helpful-container',
                        header: 'Was this article helpful?',
                        question: 'Please help us improve on the content of this site.  Was this article helpful?',
                        thankYou: "We're glad you're enjoying our content!",
                        yes: 'Yes',
                        no: 'No',
                        userClasses: '',
                        headerClasses: '',
                        questionClasses: '',
                        buttonClasses: 'helpful-button small-button',
                        disabled: false,
                        addCookieRemover: false,
                        destination: '',
                        css: {
                            color: '#777777',
                            position: 'relative',
                            float : 'none'
                        }
                    },

                    //https://developer.mozilla.org/en-US/docs/Web/API/document.cookie
                    _cookieApi : (function(){

                        return {
                            getItem: function (sKey) {
                                return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*" + encodeURIComponent(sKey).replace(/[\-\.\+\*]/g, "\\$&") + "\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1")) || null;
                            },
                            setItem: function (sKey, sValue, vEnd, sPath, sDomain, bSecure) {
                                if (!sKey || /^(?:expires|max\-age|path|domain|secure)$/i.test(sKey)) { return false; }
                                var sExpires = "";
                                if (vEnd) {
                                    switch (vEnd.constructor) {
                                        case Number:
                                            sExpires = vEnd === Infinity ? "; expires=Fri, 31 Dec 9999 23:59:59 GMT" : "; max-age=" + vEnd;
                                            break;
                                        case String:
                                            sExpires = "; expires=" + vEnd;
                                            break;
                                        case Date:
                                            sExpires = "; expires=" + vEnd.toUTCString();
                                            break;
                                    }
                                }
                                document.cookie = encodeURIComponent(sKey) + "=" + encodeURIComponent(sValue) + sExpires + (sDomain ? "; domain=" + sDomain : "") + (sPath ? "; path=" + sPath : "") + (bSecure ? "; secure" : "");
                                return true;
                            },
                            removeItem: function (sKey, sPath, sDomain, callback) {
                                if (!sKey || !this.hasItem(sKey)) { return false; }
                                document.cookie = encodeURIComponent(sKey) + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT" + ( sDomain ? "; domain=" + sDomain : "") + ( sPath ? "; path=" + sPath : "");
                                return callback();
                            },
                            hasItem: function (sKey) {
                                return (new RegExp("(?:^|;\\s*)" + encodeURIComponent(sKey).replace(/[\-\.\+\*]/g, "\\$&") + "\\s*\\=")).test(document.cookie);
                            }
                        }

                    })(),

                    _setOption: function ( key, value ) {
                        console.log('in set option');

                        var self = this;

                        switch (key) {
                            case 'someValue':
                                //this.options.someValue = doSomethingWith( value );
                                break;
                            default:
                                this.options[ key ] = value;
                                self.refresh();
                                break;
                        }

                        // For UI 1.9 the _super method can be used instead
                        this._super( "_setOption", key, value );
                    },

                    _clearCookie: function(){
                        var self = this;

                        console.log('clearCookie');
                        this._cookieApi.removeItem(this.options.helpfulCookie, false, false, function(){
                            self.refresh();
                        });

                    },

                    _setResponse: function(el){

                        console.log($(el).data());
                        var self = this,
                                buttonData = window.btoa(document.URL) + $(el).data('ui-response').value,
                                helpfulCookie = this.options.helpfulCookie,
                                currentCookie = this._cookieApi.getItem(helpfulCookie) || '';

                        $.ajax({
                            context: el,
                            url: self.options.url,
                            dataType: 'jsonp',
                            crossDomain: 'true',
                            data: {
                                'set' : buttonData
                            },
                            success: function(data){
                                console.log('success');
                                var response = data.hype;
                                //set new cookie for this domain url append a pipe for future splits
                                //docCookies.setItem(name, value[, end[, path[, domain[, secure]]]])
                                self._cookieApi.setItem(helpfulCookie, buttonData + '|' + currentCookie, Infinity);
                                self.refresh();

                            },
                            error: function(err){
                                //run silent, run deep
                            }
                        });
                    },

                    _checkCookie: function(){
                        var self = this,
                                helpfulCookie = this.options.helpfulCookie;

                        if(self._cookieApi.hasItem(helpfulCookie)){
                            //split on pipe and check array for isHelpfulTrue
                            console.log('init has cookie', self._cookieApi.getItem(helpfulCookie));
                            var prevCookieIds =  self._cookieApi.getItem(helpfulCookie).split('|');
                            prevCookieIds.pop();
                            var newCookieIds = [];
                            for(var i in prevCookieIds){
                                console.log('each cookie bit', prevCookieIds[i]);
                                if(prevCookieIds[i] === window.btoa(document.URL)+'true'||'false'){
                                    console.log('found cookie bit', prevCookieIds[i]);
                                    self.options.disabled = true;
                                }
                            }
                        }else{
                            self.options.disabled = false;
                        }
                    },

                    _disableButtons: function(){
                        this.buttonNo.detach();
                        this.buttonYes.detach();
                    },

                    _enableButtons: function(){
                        this.buttonNo.appendTo(this.target);
                        this.buttonYes.appendTo(this.target);
                    },

                    _create: function(){

                        var self = this,
                                classes = this.options.baseClass +' '+ this.options.userClasses,
                                helpfulId = this.options.helpfulId,
                                target = this.element;

                        this.target = this.element;

                        //Create elements needed for the complete survey
                        var header = (this.header = $('<h3 />'))
                                        .html(this.options.header)
                                        .addClass(this.options.headerClasses)
                                        .appendTo(target),

                                question =  (this.question = $('<span />'))
                                        .html(this.options.question)
                                        .addClass(this.options.questionClasses)
                                        .appendTo(target),

                                buttonNo = (this.buttonNo = $('<button />'))
                                        .html(this.options.no)
                                        .addClass(this.options.buttonClasses + ' helpful-no')
                                        .data('ui-response', {value: false})
                                        .appendTo(target),

                                buttonYes = (this.buttonYes = $('<button />'))
                                        .html(this.options.yes)
                                        .addClass(this.options.buttonClasses + ' helpful-yes')
                                        .data('ui-response', {value: true})
                                        .appendTo(target),

                                buttonClear = (self.buttonClear = $('<button />')
                                        .addClass(this.options.buttonClasses)
                                        );

                        //Bind any events
                        this._bindEvents();

                        this.refresh();

                        //return from this to allow for chaining
                        return this
                    },

                    _bindEvents: function(){

                        var self = this,
                                buttonYes = this.buttonYes,
                                buttonNo = this.buttonNo,
                                buttonClear = this.buttonClear,
                                buttons = buttonYes.add(buttonNo);

                        //Event dispatch and pub / sub binding
                        buttons.bind({
                            click: function(){
                                console.log('click');
                                self._setResponse(this);
                            }
                        });

                        buttonClear.bind({
                            click: function(){
                                console.log('clear');
                                self._clearCookie();
                            }
                        });


                    },

                    _destroy: function () {
                        this.element.remove();
                    },

                    refresh: function(init){

                        this._checkCookie();

                        console.log('disabled: ',this.options.disabled);

                        if(this.options.disabled === true){
                            console.log('this should be disabled yo');
                            this.question.html(this.options.thankYou);
                            this._disableButtons();
                        }else{
                            console.log('this should be enabled yosef');
                            this.question.html(this.options.question);
                            this._enableButtons();
                        }

                        if(this.options.addCookieRemover){
                            this.buttonClear
                                    .detach()
                                    .html('Clear cookies')
                                    .appendTo(this.target);
                        }else{
                            this.buttonClear
                                    .detach();
                        }

                        if(!init) {
                            this._trigger('refresh');
                        }

                    }

                });

            })(jQuery, window, document);


            //instantiate some helpful counters
            $('.helpful').helpful({
                helpfulId: 'helpful-container',
                addCookieRemover: true
            });


        </script>

</body>
</html>
